<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Retirement Strategy Analyzer</title>
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --accent-green: #059669;
            --accent-orange: #d97706;
            --accent-purple: #7c3aed;
            --chart-grid: #e2e8f0;
            --milestone-bg: #f1f5f9;
        }

        [data-theme="dark"] {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            --primary: #3b82f6;
            --primary-hover: #60a5fa;
            --accent-green: #34d399;
            --accent-orange: #fbbf24;
            --accent-purple: #a78bfa;
            --chart-grid: #334155;
            --milestone-bg: #334155;
        }

        /* GLOBAL FIXES FOR MOBILE OVERFLOW */
        html {
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: hidden;
        }
        *, *::before, *::after {
            box-sizing: inherit;
        }

        * {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: var(--bg-color);
            color: var(--text-main);
            padding: 15px;
            transition: background 0.3s;
            line-height: 1.5;
            font-size: 16px;
            max-width: 100%;
            overflow-x: hidden;
        }

        /* --- Header --- */
        header { 
            display: flex; 
            flex-direction: column; /* Stack by default on mobile */
            gap: 15px; 
            margin-bottom: 20px; 
            padding-bottom: 15px; 
            border-bottom: 1px solid var(--border); 
        }
        
        .header-content h1 {
            font-size: 1.4rem;
            font-weight: 800;
            letter-spacing: -0.025em;
            margin: 0;
            line-height: 1.2;
        }
        .header-controls {
            display: flex;
            gap: 10px;
            width: 100%;
            justify-content: flex-start;
            flex-wrap: wrap;
        }
        
        button.icon-btn {
            cursor: pointer;
            width: 42px;
            height: 42px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-main);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: 0.2s;
            flex-shrink: 0;
        }
        button.icon-btn:hover { background: var(--border); }
        button.primary-icon { background: var(--primary); color: white; border: none; }

        /* Desktop Header Override */
        @media (min-width: 768px) {
            header {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            .header-controls {
                width: auto;
                flex-wrap: nowrap;
            }
        }

        /* --- Layout Grid --- */
        .grid-container { 
            display: grid; 
            grid-template-columns: 1fr; /* Single column default */
            gap: 20px; 
            max-width: 1400px; 
            width: 100%;
            margin: 0 auto;
            overflow-x: hidden;
        }
        
        @media (min-width: 1024px) { 
            .grid-container { grid-template-columns: 350px 1fr; } 
        }

        /* --- Cards --- */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid var(--border);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            padding: 15px;
            max-width: 100%;
        }

        .card-header {
            font-weight: 700;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 8px;
            font-size: 1.05rem;
        }
        
        /* --- Inputs --- */
        .input-group { margin-bottom: 15px; }
        .input-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .input-group input,
        .input-group select {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-color);
            color: var(--text-main);
            font-size: 1rem;
            appearance: none;
        }
        .input-group input:focus {
            outline: 2px solid var(--primary);
            border-color: transparent;
        }
        
        .range-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        input[type="range"] {
            flex: 1;
            accent-color: var(--primary);
            height: 24px;
            cursor: pointer;
            width: 100%;
        }
        .range-val {
            font-variant-numeric: tabular-nums;
            width: 45px;
            text-align: right;
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* --- Breakdown Box --- */
        .breakdown-box {
            background: var(--milestone-bg);
            border-radius: 8px;
            padding: 12px;
            font-size: 0.85rem;
            border: 1px solid var(--border);
        }
        .breakdown-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .breakdown-row:last-child {
            margin-bottom: 0;
            padding-top: 6px;
            border-top: 1px solid var(--border);
            font-weight: 700;
        }
        .bd-label {
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .bd-val {
            font-family: monospace;
            font-weight: 600;
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            flex-shrink: 0;
        }
        .breakdown-notes {
            margin-top: 8px;
            font-size: 0.78rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* --- Stats Grid --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* 2 cols on mobile baseline */
            gap: 10px; 
            margin-bottom: 20px; 
            width: 100%;
        }
        .stat-box { 
            padding: 12px; 
            background: var(--bg-color); 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            min-width: 0;
        }
        .stat-box h4 {
            color: var(--text-muted);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        .stat-box .value {
            font-size: 1rem;
            font-weight: 800;
            display: block;
            margin-bottom: 2px;
            word-break: break-word;
        }
        .stat-box .sub-value {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-weight: 500;
        }
        .stat-box.highlight { border-left: 3px solid var(--primary); }
        .stat-box.green { border-left: 3px solid var(--accent-green); }
        .stat-box.purple { border-left: 3px solid var(--accent-purple); }
        
        /* Highlight spans full width on mobile for emphasis */
        .stat-box:first-child { grid-column: span 2; } 

        @media (min-width: 600px) {
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            .stat-box:first-child {
                grid-column: auto;
            }
        }

        /* --- Chart --- */
        .chart-wrapper { 
            height: 300px; 
            width: 100%;
            position: relative; 
            margin-top: 20px; 
            border: 1px solid var(--border); 
            border-radius: 8px; 
            padding: 10px 5px 25px 35px; 
            background: var(--bg-color); 
            overflow: hidden; 
        }
        svg {
            width: 100%;
            height: 100%;
            overflow: visible;
        }
        .axis-line { stroke: var(--border); stroke-width: 1; }
        .grid-line { stroke: var(--chart-grid); stroke-dasharray: 4; stroke-width: 1; }
        .line-con { fill: none; stroke: var(--accent-orange); stroke-width: 3; stroke-linejoin: round; }
        .line-mod { fill: none; stroke: var(--accent-green); stroke-width: 3; stroke-linejoin: round; }
        .line-hist { fill: none; stroke: var(--accent-purple); stroke-width: 3; stroke-linejoin: round; stroke-dasharray: 5,5; }
        .chart-label { font-size: 10px; fill: var(--text-muted); }

        /* --- Table --- */
        .table-container { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch; 
            margin-top: 10px; 
            border-radius: 8px; 
            border: 1px solid var(--border); 
            max-height: 400px;
            width: 100%;
            max-width: 100%;
        }
        .table-explainer {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
            text-align: right;
            background: var(--card-bg);
            min-width: 0;              /* Let it shrink to viewport */
            table-layout: fixed;       /* Columns share available width */
        }
        th, td {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            white-space: normal;       /* Allow wrapping */
            word-wrap: break-word;
            overflow-wrap: anywhere;
        }
        th {
            background: var(--bg-color);
            color: var(--text-muted);
            font-weight: 600;
            text-align: right;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th:first-child,
        td:first-child {
            text-align: left;
            position: sticky;
            left: 0;
            background: var(--card-bg);
            z-index: 20;
            border-right: 1px solid var(--border);
        }
        th:first-child {
            z-index: 30;
            background: var(--bg-color);
        }
        .inc-cell {
            color: var(--text-muted);
            font-size: 0.75rem;
            display: block;
        }

        .swr-controls {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            flex-wrap: wrap;
        }
        .swr-controls select {
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-color);
            color: var(--text-main);
            font-size: 0.8rem;
        }

        /* --- Milestones --- */
        .milestone-container {
            display: grid;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }
        .milestone {
            display: flex;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: var(--milestone-bg);
            border-left: 4px solid var(--text-muted);
            align-items: flex-start;
            font-size: 0.9rem;
        }
        .milestone.active {
            border-left-color: var(--primary);
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-left: 4px solid var(--primary);
        }
        .milestone .age-badge {
            background: var(--text-main);
            color: var(--bg-color);
            padding: 3px 8px;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.8rem;
            min-width: 40px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .tag {
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            background: #e2e8f0;
            color: #334155;
        }
        .tag-vti { background: #dbeafe; color: #1e40af; }
        .tag-voo { background: #dcfce7; color: #166534; }

        .tooltip {
            position: absolute;
            background: var(--card-bg);
            border: 1px solid var(--border);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.8rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.1s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 100;
            line-height: 1.4;
            white-space: nowrap;
            max-width: 90%;
        }

        .strategy-body {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .strategy-body h4 {
            font-size: 0.85rem;
            font-weight: 700;
            margin-bottom: 2px;
            color: var(--text-main);
        }

        .strategy-body h5 {
            font-size: 0.82rem;
            font-weight: 700;
            margin-bottom: 2px;
            color: var(--text-main);
        }

        .strategy-body ul {
            padding-left: 18px;
            margin: 4px 0 8px 0;
        }

        .strategy-body li {
            margin-bottom: 4px;
        }

        .broker-links {
            font-size: 0.8rem;
            margin-top: 6px;
        }

        .broker-links a {
            color: var(--primary);
            text-decoration: none;
        }

        .broker-links a:hover {
            text-decoration: underline;
        }

        /* Mini comparison table inside Strategy Insight */
        .mini-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.78rem;
            margin: 6px 0 8px 0;
        }
        .mini-table th,
        .mini-table td {
            border: 1px solid var(--border);
            padding: 4px 6px;
            text-align: left;
            white-space: normal;
            word-wrap: break-word;
        }
        .mini-table th {
            background: var(--bg-color);
            color: var(--text-muted);
        }

        /* --- MOBILE-SPECIFIC TUNING FOR VERY SMALL VIEWPORTS --- */
        @media (max-width: 480px) {
            body {
                padding: 8px;
            }

            header {
                align-items: flex-start;
            }

            .card {
                padding: 10px;
            }

            .grid-container {
                width: 100%;
                max-width: 100%;
            }

            .stats-grid {
                grid-template-columns: 1fr;   /* single-column stats on very small screens */
            }
            .stat-box:first-child {
                grid-column: span 1;
            }

            .chart-wrapper {
                height: 220px;
                padding: 6px 0 18px 28px;
            }

            /* Table: smaller font + tighter padding, no hard min-width */
            table {
                font-size: 0.75rem;
                min-width: 0;
            }
            th, td {
                padding: 6px 4px;
            }

            .mini-table {
                font-size: 0.75rem;
            }
        }

        /* --- Print Styles --- */
        .print-summary { display: none; }
        
        @media print {
            @page { margin: 0.5in; size: letter portrait; }
            body {
                background: white;
                color: black;
                font-size: 9pt;
                padding: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                width: 100%;
                overflow: visible;
            }
            header, aside, .header-controls, #tooltip { display: none !important; }
            
            .grid-container {
                display: block;
                width: 100%;
                margin: 0;
            }
            .card {
                border: none;
                box-shadow: none;
                padding: 0;
                margin-bottom: 20px;
                background: transparent;
                page-break-inside: avoid;
            }
            .card-header {
                border-bottom: 1px solid #000;
                margin-bottom: 10px;
                padding-bottom: 5px;
                color: #000;
                font-size: 11pt;
            }
            
            /* Print Header */
            .print-summary {
                display: block;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #000;
            }
            .print-summary h1 {
                font-size: 16pt;
                margin: 0 0 10px 0;
            }
            .print-grid {
                display: grid;
                grid-template-columns: repeat(3, 1fr);
                gap: 10px;
                font-size: 10pt;
            }

            /* Stats Grid Print */
            .stats-grid {
                display: grid;
                grid-template-columns: repeat(5, 1fr);
                gap: 8px;
                margin-bottom: 15px;
            }
            .stat-box {
                border: 1px solid #ccc;
                padding: 6px;
                background: #fff !important;
            }
            .stat-box h4 {
                font-size: 7pt;
                color: #333;
            }
            .stat-box .value {
                font-size: 10pt;
                color: #000;
            }
            .stat-box .sub-value {
                font-size: 7pt;
                color: #444;
            }
            .stat-box:first-child { grid-column: auto; }

            /* Chart Print */
            .chart-wrapper {
                height: 250px;
                border: 1px solid #ccc;
                background: white;
                padding: 10px 10px 20px 30px;
                page-break-inside: avoid;
            }
            .line-con { stroke: #d97706 !important; stroke-width: 1.5px; }
            .line-mod { stroke: #059669 !important; stroke-width: 1.5px; }
            .line-hist { stroke: #7c3aed !important; stroke-width: 1.5px; }

            /* Table Print - Compact */
            .table-container {
                border: none;
                overflow: visible;
                max-height: none;
                margin-top: 10px;
            }
            table {
                font-size: 8pt;
                width: 100%;
                border: 1px solid #ccc;
                min-width: 0;
            }
            th {
                background: #eee !important;
                color: #000;
                border: 1px solid #999;
                padding: 3px 5px;
            }
            td {
                padding: 3px 5px;
                border: 1px solid #ddd;
            }
            .inc-cell {
                display: inline;
                margin-left: 4px;
                font-size: 7pt;
                color: #555;
            }
            .inc-cell::before { content: "("; }
            .inc-cell::after { content: ")"; }

            /* Milestones Print - Two Columns */
            .milestone-container {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 10px;
                overflow: visible;
                max-height: none;
            }
            .milestone {
                padding: 6px;
                border: 1px solid #ccc;
                font-size: 8pt;
                background: white !important;
                border-left-width: 2px !important;
            }
            .milestone .age-badge {
                background: #eee !important;
                color: #000;
                border: 1px solid #999;
                font-size: 7pt;
                padding: 2px 4px;
            }
            .milestone-details h5 {
                color: #000;
                font-size: 9pt;
                margin-bottom: 2px;
            }
            .milestone-details p {
                color: #333;
                font-size: 8pt;
            }
        }
    </style>
</head>
<body>

<header>
    <div class="header-content">
        <h1>Retirement Strategy Center</h1>
        <div style="font-size: 0.9rem; color: var(--text-muted);">2026 Tax-Aware Analysis</div>
    </div>
    <div class="header-controls">
        <button class="icon-btn" onclick="window.print()" title="Print Report">üñ®Ô∏è</button>
        <button class="icon-btn" onclick="toggleTheme()" id="themeBtn" title="Toggle Theme">üåô</button>
        <button class="icon-btn primary-icon" onclick="downloadPage()" title="Download Offline Tool">üì•</button>
    </div>
</header>

<!-- Print Only Summary Header -->
<div class="print-summary" id="printSummary"></div>

<div class="grid-container">
    <!-- Controls Sidebar -->
    <aside>
        <div class="card">
            <div class="card-header">Your Inputs</div>
            
            <div class="input-group">
                <label>Current Age</label>
                <div class="range-wrapper">
                    <input type="range" id="age" min="20" max="70" value="40" oninput="updateAll()">
                    <span class="range-val" id="ageDisplay">40</span>
                </div>
            </div>

            <div class="input-group">
                <label>Filing Status</label>
                <select id="filingStatus" onchange="updateAll()">
                    <option value="single">Single</option>
                    <option value="mfj_single">Married (Single Earner)</option>
                    <option value="mfj_dual">Married (Dual Earner)</option>
                </select>
            </div>
            
            <div class="input-group">
                <label>Current Portfolio Value ($)</label>
                <input type="number" id="currentBalance" value="528000" step="1000" oninput="updateAll()">
            </div>
            
            <div class="input-group">
                <label>Years to Project</label>
                <div class="range-wrapper">
                    <input type="range" id="years" min="5" max="40" value="25" oninput="updateAll()">
                    <span class="range-val" id="yearsDisplay">25</span>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">Contribution Strategy</div>
            
            <div class="input-group">
                <label>Annual Investment ($)</label>
                <input type="number" id="annualContribution" value="30500" step="500" oninput="updateAll()">
            </div>

            <div class="breakdown-box" id="contribBreakdown">
                <!-- Populated via JS -->
            </div>
        </div>

        <div class="card">
            <div class="card-header">Strategy Insight</div>
            <div class="strategy-body">
                <div>
                    <h4>The ‚ÄúBarbell‚Äù Approach</h4>
                    <p>
                        Think of your portfolio as a barbell: one plate is <span class="tag tag-voo">VOO</span> (large, profitable U.S. companies), 
                        the other plate is <span class="tag tag-vti">VTI</span> (the entire U.S. stock market). The bar in the middle is your 
                        tax-advantaged accounts (401(k), IRA) plus taxable brokerage.
                    </p>
                </div>

                <div>
                    <h4>Where New Contributions Go</h4>
                    <p>
                        The contribution breakdown routes dollars into:
                    </p>
                    <ul>
                        <li><strong>401(k) / 403(b):</strong> Pre-tax or Roth contributions, usually your biggest tax-advantaged bucket.</li>
                        <li><strong>IRAs (Roth/Traditional):</strong> Personal and spousal IRAs to add more tax shelter.</li>
                        <li><strong>Taxable Brokerage:</strong> Flexible, easy-access money (good for early retirement or bridge years), but fully taxable.</li>
                    </ul>
                    <p style="font-size:0.78rem;">
                        The engine here is: max out 401(k) first, then IRAs, then let excess flow into taxable brokerage.
                        That keeps more of your growth sheltered while still building a flexible pool of money you can tap before traditional retirement age.
                    </p>
                </div>

                <div>
                    <h4>VOO vs VTI ‚Äì Why Picking One Is Usually Smarter</h4>
                    <p>
                        It is generally smarter to pick <strong>only one</strong> of these funds. Investing in both
                        <span class="tag tag-voo">VOO</span> and <span class="tag tag-vti">VTI</span> adds complexity without providing
                        meaningful diversification.
                    </p>

                    <h5>1. The Illusion of Diversification</h5>
                    <ul>
                        <li><strong>Extreme overlap:</strong> VTI is market-cap weighted. Because the S&P 500 companies are so massive, they make up roughly <strong>80‚Äì85%</strong> of VTI by weight.</li>
                        <li><strong>Correlation ~0.99:</strong> If VOO goes up 1%, VTI will usually move very close to 1% as well.</li>
                        <li><strong>Result:</strong> Holding both just tilts you slightly toward large-cap stocks. You are mostly buying the same companies twice.</li>
                    </ul>

                    <h5>2. Comparison at a Glance</h5>
                    <table class="mini-table">
                        <thead>
                            <tr>
                                <th>Feature</th>
                                <th>VOO (S&P 500)</th>
                                <th>VTI (Total Market)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Scope</td>
                                <td>Top ~500 U.S. companies (Large-Cap)</td>
                                <td>~3,600+ U.S. companies (Large, Mid, &amp; Small)</td>
                            </tr>
                            <tr>
                                <td>Expense Ratio</td>
                                <td>0.03%</td>
                                <td>0.03%</td>
                            </tr>
                            <tr>
                                <td>Top 10 Holdings</td>
                                <td>Apple, Microsoft, NVIDIA, etc.</td>
                                <td>Almost identical to VOO (slightly lower weights)</td>
                            </tr>
                            <tr>
                                <td>Performance</td>
                                <td>Slightly higher in recent tech/large-cap rallies</td>
                                <td>Very similar long-term performance</td>
                            </tr>
                            <tr>
                                <td>Volatility</td>
                                <td>Slightly lower</td>
                                <td>Slightly higher (more small/mid caps)</td>
                            </tr>
                        </tbody>
                    </table>

                    <h5>3. Which One Should You Pick?</h5>
                    <p><strong>Fees (0.03%) and tax efficiency are essentially the same.</strong> The choice is about philosophy:</p>
                    <ul>
                        <li><strong>Choose VOO if:</strong>
                            <ul>
                                <li>You believe the largest, most established U.S. companies will continue to drive the market.</li>
                                <li>You want a ‚Äúcleaner‚Äù portfolio focused on blue-chip names and prefer to exclude smaller, riskier companies.</li>
                            </ul>
                        </li>
                        <li><strong>Choose VTI if:</strong>
                            <ul>
                                <li>You want to own <em>everything</em> and never worry about missing a small-cap or mid-cap breakout decade.</li>
                                <li>You prefer a logically ‚Äúcomplete‚Äù passive strategy that does not require guessing which company size will win.</li>
                            </ul>
                        </li>
                    </ul>

                    <h5>4. Strategic Exception ‚Äì Tax-Loss Harvesting</h5>
                    <p style="font-size:0.8rem;">
                        The main time it makes sense to actively ‚Äúuse‚Äù both funds is in a <strong>taxable brokerage account</strong> for
                        <strong>tax-loss harvesting</strong>:
                    </p>
                    <ul style="font-size:0.8rem;">
                        <li>They track different indices (S&amp;P 500 vs CRSP US Total Market) but behave very similarly.</li>
                        <li>If VOO drops, you can sell it to realize a tax loss and immediately buy VTI to stay invested.</li>
                        <li>This usually avoids the IRS ‚Äúwash sale‚Äù rule, since the funds are not considered <em>substantially identical</em> by most interpretations.</li>
                    </ul>
                </div>

                <div>
                    <h4>VOO / VTI Summary</h4>
                    <p style="font-size:0.8rem;">
                        For most long-term investors, <strong>picking one core fund (VOO or VTI) and sticking with it</strong> is simpler and cleaner.
                        If you also want a tax-loss harvesting partner in taxable accounts, you can keep the other fund on standby for that specific purpose.
                    </p>
                </div>

                <div class="broker-links">
                    <strong>Open an account:</strong>
                    <ul>
                        <li>
                            <a href="https://investor.vanguard.com/home" target="_blank" rel="noopener noreferrer">
                                Open an account at Vanguard
                            </a>
                        </li>
                        <li>
                            <a href="https://www.fidelity.com/open-account/overview" target="_blank" rel="noopener noreferrer">
                                Open an account at Fidelity
                            </a>
                        </li>
                    </ul>
                    <span style="font-size:0.75rem; color:var(--text-muted);">
                        (This tool is for education only and does not replace personalized investment advice.)
                    </span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main>
        <!-- Stats -->
        <div class="stats-grid">
            <div class="stat-box highlight">
                <h4>Retire Age</h4>
                <div class="value" id="endAge">65</div>
                <div class="sub-value">Target</div>
            </div>
            <div class="stat-box">
                <h4>Invested</h4>
                <div class="value" id="totalInvested">$1.2M</div>
                <div class="sub-value">Principal</div>
            </div>
            <div class="stat-box">
                <h4>Consrv (7%)</h4>
                <div class="value" id="resCon">$2.1M</div>
                <div class="sub-value" id="incCon">$7k/mo</div>
            </div>
            <div class="stat-box green">
                <h4>Mod (10%)</h4>
                <div class="value" id="resMod">$3.5M</div>
                <div class="sub-value" id="incMod">$11k/mo</div>
            </div>
            <div class="stat-box purple">
                <h4>Hist (12.9%)</h4>
                <div class="value" id="resHist">$6.2M</div>
                <div class="sub-value" id="incHist">$20k/mo</div>
            </div>
        </div>

        <!-- Chart -->
        <div class="card">
            <div class="card-header">
                Growth Projection
                <div style="font-size: 0.75rem; font-weight: 500; display: flex; gap: 10px; flex-wrap: wrap;">
                    <span style="color: var(--accent-purple)">-- Hist</span>
                    <span style="color: var(--accent-green)">‚îÄ‚îÄ Mod</span>
                    <span style="color: var(--accent-orange)">‚îÄ‚îÄ Consrv</span>
                </div>
            </div>
            
            <div class="chart-wrapper">
                <svg id="mainChart" preserveAspectRatio="none"></svg>
                <div id="tooltip" class="tooltip"></div>
            </div>
        </div>

        <!-- Yearly Data Table -->
        <div class="card">
            <div class="card-header">Yearly Performance Potentials</div>

            <div class="swr-controls">
                <span>Withdrawal rate for income estimates:</span>
                <select id="swrSelect" onchange="updateAll()">
                    <option value="0.03">3%</option>
                    <option value="0.04" selected>4%</option>
                    <option value="0.05">5%</option>
                    <option value="0.06">6%</option>
                </select>
                <span style="font-size:0.75rem;">
                    Higher % = more income now, higher risk of depleting the portfolio sooner.
                </span>
            </div>

            <div class="table-explainer">
                Each row shows the projected end-of-year balance for each growth assumption. The smaller gray line
                under each dollar amount is an estimated monthly income if you withdrew 
                <strong><span id="swrLabel">4%</span> per year</strong> from that balance, split into 12 equal monthly payments.
            </div>

            <div class="table-container">
                <table id="projTable">
                    <thead>
                        <tr>
                            <th>Year</th>
                            <th>Age</th>
                            <th>Total Invested</th>
                            <th>Conservative (7%)</th>
                            <th>Moderate (10%)</th>
                            <th>Historical (12.9%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Milestones -->
        <div class="card">
            <div class="card-header">Key Milestones</div>
            <div id="milestoneList" class="milestone-container"></div>
        </div>
    </main>
</div>

<script>
    // 2026 Limits
    const LIMITS = {
        base401k: 24500, 
        catchUp401k: 7500,
        superCatchUp401k: 11250, // Ages 60-63
        baseIRA: 7500, 
        catchUpIRA: 1000 
    };

    const STATE = {
        theme: 'light',
        age: 40,
        balance: 528000,
        contribution: 30500,
        years: 25,
        status: 'single',
        withdrawalRate: 0.04
    };

    function init() {
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            toggleTheme();
        }
        updateAll();
    }

    function toggleTheme() {
        STATE.theme = STATE.theme === 'light' ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', STATE.theme);
        document.getElementById('themeBtn').innerText = STATE.theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
    }

    function downloadPage() {
        // Create a clone of the document to modify for saving
        const docClone = document.documentElement.cloneNode(true);
        
        // Preserve current input values into the HTML attributes
        docClone.querySelector('#age').setAttribute('value', STATE.age);
        docClone.querySelector('#currentBalance').setAttribute('value', STATE.balance);
        docClone.querySelector('#annualContribution').setAttribute('value', STATE.contribution);
        docClone.querySelector('#years').setAttribute('value', STATE.years);
        
        // Handle select
        const statusSelect = docClone.querySelector('#filingStatus');
        const options = statusSelect.querySelectorAll('option');
        options.forEach(opt => {
            if (opt.value === STATE.status) opt.setAttribute('selected', 'selected');
            else opt.removeAttribute('selected');
        });

        // Handle withdrawal rate select
        const swrSelectClone = docClone.querySelector('#swrSelect');
        if (swrSelectClone) {
            Array.from(swrSelectClone.options).forEach(opt => {
                if (parseFloat(opt.value) === STATE.withdrawalRate) {
                    opt.setAttribute('selected', 'selected');
                } else {
                    opt.removeAttribute('selected');
                }
            });
        }

        const htmlContent = docClone.outerHTML;
        const blob = new Blob([htmlContent], {type: 'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'retirement_strategy_tool.html';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
    }

    function updateAll() {
        // Update State from inputs
        STATE.age = parseInt(document.getElementById('age').value);
        STATE.years = parseInt(document.getElementById('years').value);
        STATE.balance = parseFloat(document.getElementById('currentBalance').value);
        STATE.contribution = parseFloat(document.getElementById('annualContribution').value);
        STATE.status = document.getElementById('filingStatus').value;

        // Withdrawal rate
        const swrSelect = document.getElementById('swrSelect');
        if (swrSelect) {
            STATE.withdrawalRate = parseFloat(swrSelect.value);
        }
        const swrLabel = document.getElementById('swrLabel');
        if (swrLabel) {
            const pct = (STATE.withdrawalRate * 100).toFixed(1).replace(/\.0$/, '');
            swrLabel.innerText = pct + '%';
        }

        // Displays
        document.getElementById('ageDisplay').innerText = STATE.age;
        document.getElementById('yearsDisplay').innerText = STATE.years;
        document.getElementById('endAge').innerText = STATE.age + STATE.years;

        // Update Print Summary
        const summary = document.getElementById('printSummary');
        summary.innerHTML = `
            <h1>Retirement Strategy Report</h1>
            <div class="print-grid">
                <div><strong>Projection:</strong> Age ${STATE.age} to ${STATE.age + STATE.years}</div>
                <div><strong>Status:</strong> ${STATE.status.replace('_', ' ').toUpperCase()}</div>
                <div><strong>Start Balance:</strong> ${formatMoneyCompact(STATE.balance)}</div>
                <div><strong>Annual Contrib:</strong> ${formatMoneyCompact(STATE.contribution)}</div>
            </div>
        `;

        // Calc
        const results = calculateGrowth();
        const final = results[results.length-1];
        
        // Update Breakdown
        renderBreakdown(results[0].limits); // Use first year limits for display context

        // Update Stats ‚Äì using default 4% rule for headline income to keep it simple
        document.getElementById('totalInvested').innerText = formatMoneyCompact(final.invested);
        document.getElementById('resMod').innerText = formatMoneyCompact(final.mod);
        document.getElementById('incMod').innerText = formatMonthlyIncome(final.mod);
        document.getElementById('resCon').innerText = formatMoneyCompact(final.con);
        document.getElementById('incCon').innerText = formatMonthlyIncome(final.con);
        document.getElementById('resHist').innerText = formatMoneyCompact(final.hist);
        document.getElementById('incHist').innerText = formatMonthlyIncome(final.hist);

        // Render Viz
        renderChart(results);
        renderTable(results);
        renderMilestones(STATE.age);
    }

    function calculateLimits(age, status) {
        // 1. Calculate Max Capacity for each bucket based on Age & Status
        let max401k = LIMITS.base401k;
        let maxIRA = LIMITS.baseIRA;

        // Age logic
        if (age >= 60 && age <= 63) max401k += LIMITS.superCatchUp401k;
        else if (age >= 50) max401k += LIMITS.catchUp401k;
        
        if (age >= 50) maxIRA += LIMITS.catchUpIRA;

        // Status Logic
        if (status === 'mfj_single') {
            // 1 Earner: 1x 401k, 2x IRA (Spousal)
            maxIRA *= 2; 
        } else if (status === 'mfj_dual') {
            // 2 Earners: 2x 401k, 2x IRA
            max401k *= 2;
            maxIRA *= 2;
        }

        return { max401k, maxIRA };
    }

    function renderBreakdown(limits) {
        let remaining = STATE.contribution;
        
        // Priority Fill: 401k -> IRA -> Taxable
        let fill401k = Math.min(remaining, limits.max401k);
        remaining -= fill401k;
        
        let fillIRA = Math.min(remaining, limits.maxIRA);
        remaining -= fillIRA;
        
        let fillTaxable = remaining; // Whatever is left

        const total = STATE.contribution || 1; // avoid division by zero
        const p401 = total > 0 ? Math.round((fill401k / total) * 100) : 0;
        const pIRA = total > 0 ? Math.round((fillIRA / total) * 100) : 0;
        const pTax = total > 0 ? Math.round((fillTaxable / total) * 100) : 0;

        const pieces = [];
        if (fill401k > 0) pieces.push(`${p401}% into 401(k)/403(b)`);
        if (fillIRA > 0) pieces.push(`${pIRA}% into IRAs (Roth/Trad)`);
        if (fillTaxable > 0) pieces.push(`${pTax}% into taxable brokerage`);

        const box = document.getElementById('contribBreakdown');
        box.innerHTML = `
            <div class="breakdown-row">
                <span class="bd-label"><span class="dot" style="background:var(--accent-green)"></span> 401(k) / 403(b)</span>
                <span class="bd-val">$${fill401k.toLocaleString()}</span>
            </div>
            <div class="breakdown-row">
                <span class="bd-label"><span class="dot" style="background:var(--accent-purple)"></span> IRA (Roth/Trad)</span>
                <span class="bd-val">$${fillIRA.toLocaleString()}</span>
            </div>
            <div class="breakdown-row">
                <span class="bd-label"><span class="dot" style="background:var(--accent-orange)"></span> Taxable Brokerage</span>
                <span class="bd-val">$${fillTaxable.toLocaleString()}</span>
            </div>
            <div class="breakdown-row">
                <span class="bd-label">Total Annual</span>
                <span class="bd-val">$${STATE.contribution.toLocaleString()}</span>
            </div>
            <div class="breakdown-notes">
                Routing summary: ${pieces.length ? pieces.join(", ") : "no contributions entered yet."}
            </div>
        `;
    }

    function calculateGrowth() {
        let data = [];
        let curCon = STATE.balance;
        let curMod = STATE.balance;
        let curHist = STATE.balance;
        let invested = STATE.balance;
        let currentAge = STATE.age;
        
        for (let i = 0; i <= STATE.years; i++) {
            // Recalculate limits every year as age changes (Catch-up triggers)
            const limits = calculateLimits(currentAge, STATE.status);
            
            data.push({
                year: new Date().getFullYear() + i,
                relYear: i,
                age: currentAge,
                con: curCon,
                mod: curMod,
                hist: curHist,
                invested: invested,
                limits: limits
            });

            if (i < STATE.years) {
                let contrib = STATE.contribution;
                invested += contrib;
                
                // Monthly Compounding
                const mRateCon = 0.07 / 12;
                const mRateMod = 0.10 / 12;
                const mRateHist = 0.129 / 12; 
                const mContrib = contrib / 12;

                for(let m=0; m<12; m++) {
                    curCon = (curCon + mContrib) * (1 + mRateCon);
                    curMod = (curMod + mContrib) * (1 + mRateMod);
                    curHist = (curHist + mContrib) * (1 + mRateHist);
                }
            }
            currentAge++;
        }
        return data;
    }

    function renderTable(data) {
        const tbody = document.querySelector('#projTable tbody');
        tbody.innerHTML = '';
        data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${d.year}</strong></td>
                <td>${d.age}</td>
                <td>${formatMoneyCompact(d.invested)}</td>
                <td>
                    ${formatMoneyCompact(d.con)}
                    <span class="inc-cell">${formatMonthlyIncome(d.con)}</span>
                </td>
                <td>
                    <strong style="color:var(--accent-green)">${formatMoneyCompact(d.mod)}</strong>
                    <span class="inc-cell">${formatMonthlyIncome(d.mod)}</span>
                </td>
                <td>
                    <span style="color:var(--accent-purple)">${formatMoneyCompact(d.hist)}</span>
                    <span class="inc-cell">${formatMonthlyIncome(d.hist)}</span>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderChart(data) {
        const svg = document.getElementById('mainChart');
        svg.innerHTML = '';
        const w = svg.clientWidth;
        const h = svg.clientHeight;
        const padLeft = 40;
        const padRight = 10;
        const padTop = 10;
        const padBottom = 20;

        const maxVal = Math.max(...data.map(d => d.hist)) * 1.1;
        
        const xScale = (i) => padLeft + (i / (data.length - 1)) * (w - padLeft - padRight);
        const yScale = (v) => h - padBottom - (v / maxVal) * (h - padTop - padBottom);

        // Horizontal grid + Y-axis labels
        for(let i=0; i<=5; i++) {
            const val = (maxVal/5)*i;
            const y = yScale(val);
            
            const line = createSVG('line', { x1: padLeft, y1: y, x2: w-padRight, y2: y, class: 'grid-line' });
            const text = createSVG('text', { x: padLeft - 5, y: y + 3, 'text-anchor': 'end', class: 'chart-label' });
            text.textContent = formatMoneyCompact(val);
            svg.appendChild(line);
            svg.appendChild(text);
        }

        // X-axis line
        const axisY = h - padBottom;
        svg.appendChild(createSVG('line', {
            x1: padLeft,
            y1: axisY,
            x2: w - padRight,
            y2: axisY,
            class: 'axis-line'
        }));

        // X-axis year labels (roughly 6 ticks)
        const step = Math.max(1, Math.floor(data.length / 6));
        for (let i = 0; i < data.length; i += step) {
            const d = data[i];
            const x = xScale(i);
            const text = createSVG('text', {
                x,
                y: axisY + 12,
                'text-anchor': 'middle',
                class: 'chart-label'
            });
            text.textContent = d.year;
            svg.appendChild(text);
        }
        // Ensure last year label is shown
        const lastIndex = data.length - 1;
        if ((lastIndex % step) !== 0) {
            const dLast = data[lastIndex];
            const xLast = xScale(lastIndex);
            const textLast = createSVG('text', {
                x: xLast,
                y: axisY + 12,
                'text-anchor': 'middle',
                class: 'chart-label'
            });
            textLast.textContent = dLast.year;
            svg.appendChild(textLast);
        }

        // Paths
        let pathMod = `M ${xScale(0)} ${yScale(data[0].mod)}`;
        let pathCon = `M ${xScale(0)} ${yScale(data[0].con)}`;
        let pathHist = `M ${xScale(0)} ${yScale(data[0].hist)}`;
        
        data.forEach((d, i) => {
            pathMod += ` L ${xScale(i)} ${yScale(d.mod)}`;
            pathCon += ` L ${xScale(i)} ${yScale(d.con)}`;
            pathHist += ` L ${xScale(i)} ${yScale(d.hist)}`;
        });

        svg.appendChild(createSVG('path', { d: pathCon, class: 'line-con' }));
        svg.appendChild(createSVG('path', { d: pathMod, class: 'line-mod' }));
        svg.appendChild(createSVG('path', { d: pathHist, class: 'line-hist' }));

        // Interactive Overlay
        const overlay = createSVG('rect', {
            x: padLeft,
            y: padTop,
            width: w - padLeft - padRight,
            height: h - padTop - padBottom,
            fill: 'transparent'
        });

        overlay.onmousemove = (e) => {
            const rect = svg.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const ratio = (x - padLeft) / (w - padLeft - padRight);
            let idx = Math.round(ratio * (data.length - 1));
            if (idx < 0) idx = 0;
            if (idx >= data.length) idx = data.length - 1;
            
            const pt = data[idx];
            const tooltip = document.getElementById('tooltip');
            
            // Tooltip position near edges
            let toolX = Math.min(Math.max(x + 10, 0), w - 10);
            let toolY = Math.max(yScale(pt.mod) - 70, 10);

            tooltip.style.left = toolX + 'px';
            tooltip.style.top = toolY + 'px';
            tooltip.style.opacity = 1;
            tooltip.innerHTML = `
                <strong>Age ${pt.age}</strong> (${pt.year})<br>
                Hist: ${formatMoneyCompact(pt.hist)}<br>
                Mod: ${formatMoneyCompact(pt.mod)}<br>
                Con: ${formatMoneyCompact(pt.con)}
            `;
        };
        overlay.onmouseleave = () => {
            document.getElementById('tooltip').style.opacity = 0;
        };
        svg.appendChild(overlay);
    }

    function renderMilestones(currentAge) {
        const container = document.getElementById('milestoneList');
        container.innerHTML = '';

        const events = [
            { age: 50, title: "Catch-Up Contributions", desc: "+$7.5k to 401k, +$1k to IRA." },
            { age: 55, title: "Rule of 55", desc: "Penalty-free 401k withdrawals if separating from service." },
            { age: 59, title: "59¬Ω Full Access", desc: "Penalty-free withdrawals from all retirement accounts." },
            { age: 60, title: "Super Catch-Up (60-63)", desc: "401k Catch-up increases to ~$11,250." },
            { age: 65, title: "Medicare Eligibility", desc: "Primary health insurance coverage begins." },
            { age: 67, title: "Social Security Full Age", desc: "100% benefit amount available." },
            { age: 73, title: "RMDs Begin", desc: "Mandatory withdrawals from Traditional accounts." }
        ];

        events.forEach(ev => {
            if (ev.age >= currentAge) {
                const div = document.createElement('div');
                div.className = `milestone ${ev.age === currentAge ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="age-badge">${ev.age}</div>
                    <div class="milestone-details">
                        <h5>${ev.title}</h5>
                        <p>${ev.desc}</p>
                    </div>
                `;
                container.appendChild(div);
            }
        });
    }

    function createSVG(type, attrs) {
        const el = document.createElementNS("http://www.w3.org/2000/svg", type);
        for (const k in attrs) el.setAttribute(k, attrs[k]);
        return el;
    }

    function formatMoneyCompact(n) {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            notation: "compact",
            maximumFractionDigits: 1
        }).format(n);
    }
    
    function formatMonthlyIncome(totalBalance) {
        const rate = STATE.withdrawalRate || 0.04;
        const monthly = (totalBalance * rate) / 12;
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            maximumFractionDigits: 0
        }).format(monthly) + "/mo";
    }

    init();
    window.addEventListener('resize', updateAll);
</script>
</body>
</html>
